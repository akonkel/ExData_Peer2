---
title: "Exploratory Data Analysis Peer Assessment 2"
author: "Alex Konkel"
date: "December 22, 2015"
output: html_document
---

This markdown document will run all the analyses and produce the graphs asked for in the 2nd peer assessment in the John Hopkins Exploratory Data Analysis Coursera class.  The course asks you to copy the relevant code directly into a browser, which seems pretty silly for a data science series that also includes work on reproducible research and sharing data/analyses.  

## Loading the Data
First we need to download the data, unzip it, and load it.
``` {r}
fileName <- c("pm_data.zip")
if(!file.exists(fileName)) {
  download.file("https://d396qusza40orc.cloudfront.net/exdata%2Fdata%2FNEI_data.zip", fileName)
  message("... Unzipping archived source data ...")
  unzip(fileName)
} else {
  message("... Source file already exists ...")
}
pm_data <- readRDS('summarySCC_PM25.rds')
pm_class <- readRDS('Source_Classification_Code.rds')
```
The data seems to load in with reasonable data classes, so we're good to go.

## Question 1: Have Emissions Decreased?
The first part of the assignment is to determine if total emissions from PM2.5 have decreased from 1999 to 2008.  As part of answering the question, we need to make a base graphics plot, saved as a PNG, that shows total emissions for 1999, 2002, 2005, and 2008.  

``` {r}
library(dplyr)
pm_data <- tbl_df(pm_data)
yearly_emissions <- pm_data %>% group_by(year) %>% summarize(total = sum(Emissions))
par(mar=c(4,4,2,0))
png('plot1.png')
with(yearly_emissions,barplot(total,names.arg=c('1999','2002','2005','2008'),xlab='year',ylab='Total PM2.5 Emissions',col='lightblue'))
dev.off()
```
It looks like emissions have indeed decreased from 1999 to 2008, although there was a lull in the middle where 2002 and 2005 are about the same.  As a more fine-grained check, we can also see if it looks like most counties have had a decline across years.
``` {r}
library(ggplot2)
emissionYearCounty <- pm_data %>% group_by(year,fips) %>% summarize(total = sum(Emissions))
g <- ggplot(emissionYearCounty,aes(as.factor(year),total,group=fips))
g+geom_line()
```

There's one obvious outlier; let's cut that out and focus on the majority of the data
``` {r}
g+geom_line()+coord_cartesian(ylim=c(0,50000))+stat_smooth(method='lm',formula=y~x,se=FALSE)
```

It's still pretty hard to see individual counties, although it seems believable that most show a decrease.  Let's just fit a model and check.
``` {r}
options(scipen=1, digits=2)
library(lme4)
mod1 <- lmer(total ~ year + (year|fips),data=emissionYearCounty)
fixedInt <- summary(mod1)$coef[,1][2]
print(fixedInt)
```
Kind of a rubbish model, but it confirms that the general trend is for emissions to drop.

## Question 2: Have Emissions Dropped in Baltimore?
Now we're going to focus our attention specifically on Baltimore.  Have emissions dropped there?  We'll just redo the earlier code but limited to Baltimore.
``` {r}
BaltByYear <- pm_data %>% group_by(year,fips) %>% summarize(total = sum(Emissions)) %>% filter(fips=='24510')
```
